{"type":"spell","system":{"description":{"value":"<p>You call forth a celestial spirit. It manifests in an angelic form in an unoccupied space that you can see within range. This corporeal form uses the Celestial Spirit stat block. When you cast the spell, choose Avenger or Defender. Your choice determines the creature’s attack in its stat block. The creature disappears when it drops to 0 hit points or when the spell ends.</p><p>The creature is an ally to you and your companions. In combat, the creature shares your initiative count, but it takes its turn immediately after yours. It obeys your verbal commands (no action required by you). If you don’t issue any, it takes the Dodge action and uses its move to avoid danger.</p><p><em><strong>At Higher Levels.</strong></em> When you cast this spell using a spell slot of 6th level or higher, use the higher level wherever the spell’s level appears in the stat block.</p><p>@UUID[Actor.Nk3HRmoPkku8YOD5]{Celestial Spirit}</p>","chat":"","unidentified":""},"source":"TCoE pg 110","activation":{"type":"action","cost":1,"condition":""},"duration":{"value":"1","units":"hour"},"cover":null,"target":{"value":null,"width":null,"units":"","type":"self"},"range":{"value":90,"long":null,"units":"ft"},"uses":{"value":null,"max":"","per":"","recovery":""},"consume":{"type":"","target":"","amount":null},"ability":"","actionType":"","attackBonus":"","chatFlavor":"","critical":{"threshold":null,"damage":""},"damage":{"parts":[],"versatile":""},"formula":"","save":{"ability":"","dc":null,"scaling":"spell"},"level":5,"school":"con","components":{"vocal":true,"somatic":true,"material":true,"ritual":false,"concentration":true},"materials":{"value":"a golden reliquary worth at least 500 gp","consumed":false,"cost":500,"supply":0},"preparation":{"mode":"prepared","prepared":true},"scaling":{"mode":"none","formula":""}},"name":"Summon Celestial","flags":{"ddbimporter":{"id":5854911,"definitionId":721194,"entityTypeId":435869154,"dndbeyond":{"lookup":"generic","lookupName":"generic","level":null,"castAtLevel":null},"originalName":"Summon Celestial","sources":[{"sourceId":67,"pageNumber":110,"sourceType":1}],"tags":["Summoning"],"version":"3.1.21","effectsApplied":true},"cf":{"id":"temp_5ex1cezbs9"},"core":{"sourceId":"Compendium.forge-vtt-shared-compendiums-dnd-beyond-shared-content.item-9-spells.GRsmELwW6N8pP1cy"},"scene-packer":{"hash":"7e3ccbdc3fd7440818738bf0cfddd0889223f088","sourceId":"Actor.do6eB8MSUwf006uc.Item.Wji3Sm34iQkOrb6V"},"itemacro":{"macro":{"name":"Summon Celestial","type":"script","scope":"global","command":"if (typeof args !== 'undefined') {\n  // DAE called\n  if (args[0] == \"off\") {\n    warpgate.dismiss(args[1]); // kill the token\n    return;\n  }\n}\n\nif (typeof this !== 'undefined') {\n  // WIRE called\n  this.registerFlowStep(\"summonCelestial\", true, async (activation) => {\n    let caster = game.actors.get(this.item.parent._id);\n    const casterToken = canvas.tokens.get(caster.getActiveTokens()[0].id);\n    const spellSlot = activation.config.spellLevel;\n    const upcastHealth = (spellSlot - 5) * 10; // plus 10 health for each level above 5th\n    const multiattack = Math.floor(spellSlot / 2); // half the spell level rounded down\n    const casterMsakBonus = Number(caster.system.bonuses.msak.attack.split(\"+\").filter(Number).reduce(function (total, num) { return parseFloat(total) + parseFloat(num) }));\n    const casterAttack = Number(caster.system.abilities[caster.system.attributes.spellcasting].mod) + casterMsakBonus;\n//    const casterProf = caster.system.attributes.prof;\n    let theCr = 9;\n    switch (caster.system.attributes.prof) {\n      case 5:\n        theCr = 13;\n        break;\n      case 6:\n        theCr = 17;\n        break;\n    }\n    console.log(`#### The calculated CR from a caster's proficiency of ${caster.system.attributes.prof} is ${theCr}`);\n    // min 4 max 6 @ 9th level\n\n\n    const buttonData = {\n      title: \"Choose the type of celestial spirit to summon.\",\n      buttons: [\n        {\n          label: \"Avenger\",\n          value: {\n            token: {\n              name: \"Bruiser the Avenger\"\n            },\n            actor: {\n              \"name\": \"Celestial Spirit\",\n              \"system.attributes.ac\": {\n                \"armor\": 11 + spellSlot,\n                \"flat\": 11 + spellSlot,\n                \"calc\": \"flat\"\n              }\n            },\n            embedded: {\n              Item: {\n                \"Radiant Bow\": {\n                  \"type\": \"feat\",\n                  \"img\": \"icons/weapons/bows/shortbow-recurve-yellow-blue.webp\",\n                  \"system\": {\n                    \"description.value\": `<p><em>Ranged Weapon Attack</em>: your spell attack modifier to hit [[${casterAttack}]], range 150/600 ft., one target. <em>Hit</em>: 2d6 + 2 + ${spellSlot} [the spell’s level] radiant damage.</p>`,\n                    \"source\": \"TCoE, pg. 110\",\n                    \"activation.type\": \"action\",\n                    \"target\": {\n                      \"value\": null,\n                      \"width\": null,\n                      \"units\": \"\",\n                      \"type\": \"creature\"\n                    },\n                    \"range\": {\n                      \"value\": 150,\n                      \"long\": 600,\n                      \"units\": \"ft\"\n                    },\n                    \"actionType\": \"rwak\",\n                    \"attackBonus\": `${casterAttack}`,\n                    \"damage.parts\": [[`2d6[radiant]+@mod+${spellSlot}`, \"radiant\"]],\n                    \"type.value\": \"monster\"\n                  }\n                }\n              }\n            }\n          }\n        },\n        {\n          label: \"Defender\",\n          value: {\n            token: {\n              name: \"Bruiser the Defender\"\n            },\n            actor: {\n              \"name\": \"Celestial Spirit\",\n              \"system.attributes.ac\": {\n                \"armor\": 11 + spellSlot + 2,\n                \"flat\": 11 + spellSlot + 2,\n                \"calc\": \"flat\"\n              }\n            },\n            embedded: {\n              Item: {\n                \"Radiant Mace\": {\n                  \"type\": \"feat\",\n                  \"img\": \"icons/weapons/maces/shortmace-ornate-gold.webp\",\n                  \"system\": {\n                    \"description.value\": `<p><em>Melee Weapon Attack</em>: your spell attack modifier to hit [[${casterAttack}]], range 150/600 ft., one target. <em>Hit</em>: 1d10 + 3 + ${spellSlot} [the spell’s level] radiant damage, and the celestial can choose itself or another creature it can see within 10 feet of the target. The chosen creature gains 1d10 temporary hit points.</p>`,\n                    \"source\": \"TCoE, pg. 110\",\n                    \"activation.type\": \"action\",\n                    \"target\": {\n                      \"value\": null,\n                      \"width\": null,\n                      \"units\": \"\",\n                      \"type\": \"creature\"\n                    },\n                    \"range\": {\n                      \"value\": 5,\n                      \"long\": null,\n                      \"units\": \"ft\"\n                    },\n                    \"actionType\": \"mwak\",\n                    \"attackBonus\": `${casterAttack}`,\n                    \"damage.parts\": [[`2d6[radiant]+@mod+${spellSlot}`, \"radiant\"]],\n                    \"type.value\": \"monster\"\n                  }\n                },\n                \"Radiant Mace (Healing)\": {\n                  \"type\": \"feat\",\n                  \"img\": \"icons/weapons/maces/shortmace-ornate-gold.webp\",\n                  \"system\": {\n                    \"description.value\": `<p>On a successful hit, the celestial can choose itself or another creature it can see within 10 feet of the target. The chosen creature gains 1d10 temporary hit points.</p>`,\n                    \"activation.type\": \"special\",\n                    \"target.type\": \"creature\",\n                    \"range\": {\n                      \"value\": 10,\n                      \"long\": null,\n                      \"units\": \"ft\"\n                    },\n                    \"actionType\": \"heal\",\n                    \"damage.parts\": [[\"1d10[temphp]\", \"temphp\"]],\n                    \"type.value\": \"monster\"\n                  }\n\n                }\n              }\n            }\n          }\n        }\n      ]\n    };\n\n    const choice = await warpgate.buttonDialog(buttonData);\n    if (choice === true) return {}; // break if no choice\n    const theCelestial = game.actors.getName(choice.actor.name);\n\n    // Crosshairs\n    let crosshairsDistance = 0;\n    const distanceAvailable = this.item.system.range.value;  // use the range on the source item\n    const checkDistance = async (crosshairs) => {\n      while (crosshairs.inFlight) {\n        await warpgate.wait(100); //wait for initial render\n        const ray = new Ray(casterToken.center, crosshairs);\n        const distance = canvas.grid.measureDistances([{ ray }], { gridSpaces: true })[0];\n\n        //only update if the distance has changed\n        if (crosshairsDistance !== distance) {\n          crosshairsDistance = distance;\n          if (distance > distanceAvailable) {\n            crosshairs.icon = 'icons/skills/social/wave-halt-stop.webp';\n          } else {\n            crosshairs.icon = theCelestial.prototypeToken.texture.src;\n          }\n          crosshairs.draw();\n          crosshairs.label = `${distance} ft`;\n        }\n      }\n    };\n\n    const curLocation = await warpgate.crosshairs.show(\n      {\n        size: theCelestial.prototypeToken.width, // the spawned token's size\n        interval: theCelestial.prototypeToken.width % 2 === 0 ? 1 : -1, // swap between targeting the grid square vs intersection based on token's size\n        label: '0 ft.',\n      },\n      { show: checkDistance }\n    );\n\n    // Cancel if location cancelled\n    if (curLocation.cancelled || crosshairsDistance > distanceAvailable) { return }\n    const location = { 'x': curLocation.x, 'y': curLocation.y };\n\n    // combine general and specific updates\n    let updates = {\n      token: { \"disposition\": 1 },\n      actor: {\n        \"system\": {\n          \"attributes\": {\n            \"hp\": {\n              \"value\": 40 + upcastHealth,\n              \"max\": 40 + upcastHealth,\n              \"formula\": `40 + ${upcastHealth}`\n            }\n          },\n          \"details.cr\": theCr\n        }\n      },\n      embedded: {\n        Item: {\n          \"Multiattack\": {\n            \"type\": \"feat\",\n            \"img\": \"icons/skills/melee/strike-weapons-orange.webp\",\n            \"system.description.value\": `<p>The celestial makes a number of attacks equal to half this spell's level (rounded down) [[${multiattack}]].</p>`\n          },\n          \"Healing Touch\": {\n            \"type\": \"feat\",\n            \"img\": \"icons/magic/holy/saint-glass-portrait-halo.webp\",\n            \"system\": {\n              \"description.value\": `<p>The celestial touches another creature. The target magically regains hit points equal to 2d8 + the spell’s level [[${spellSlot}]].</p>`,\n              \"activation.type\": \"action\",\n              \"target.type\": \"creature\",\n              \"range.units\": \"touch\",\n              \"actionType\": \"heal\",\n              \"damage.parts\": [[`2d8[healing]]+${spellSlot}`, \"healing\"]]\n            }\n          }\n        }\n      }\n    };\n    updates = mergeObject(updates, choice);\n\n    // define options\n    const options = { controllingActor: caster };\n\n    // Summon the token\n    const celestialTokenId = (await warpgate.spawnAt(location, choice.actor.name, updates, {}, options))[0];\n    console.log(\"#### Warpgate spawned tokenid is \", celestialTokenId);\n\n    // Update the DAE flag with the spawned token so it can be dismissed later\n    let celestialEffect = caster.effects.find(e => e.label === \"Summon Celestial\");\n    console.log(\"#### celestialEffect: \", celestialEffect);\n    celestialEffect.update({\n      \"changes\": [{\n        \"key\": \"macro.itemMacro\",\n        \"value\": `${celestialTokenId}`,\n        \"mode\": 0,\n        \"priority\": 10\n      }]\n    })\n\n  });\n\n  return this.sequence(\n    this.hasDuration(\n      this.hasConcentration(\n        this.applyConcentration()\n      )\n    ),\n    this.applyDefaultTargetsAsEffective(\n      this.sequence(\n        this.applyEffects(),\n        this.performCustomStep(\"summonCelestial\")\n      )\n    )\n  )\n}","author":"Jd73bpddRreBTuIB","_id":null,"img":"icons/svg/dice-target.svg","folder":null,"sort":0,"ownership":{"default":0},"flags":{},"_stats":{"systemId":null,"systemVersion":null,"coreVersion":null,"createdTime":null,"modifiedTime":null,"lastModifiedBy":null}}},"wire":{"override":{"target":{"value":""}},"checkedAbility":"","saveImmunity":false,"conditions":[]}},"effects":[{"label":"Summon Celestial","icon":"icons/commodities/treasure/trinket-wing-white.webp","origin":"Actor.do6eB8MSUwf006uc.Item.Wji3Sm34iQkOrb6V","duration":{"seconds":3600,"startTime":null,"combat":null,"rounds":null,"turns":null,"startRound":null,"startTurn":null},"disabled":false,"_id":"M8aQddXxDGDhlnP8","changes":[{"key":"macro.itemMacro","mode":0,"value":"tokenID","priority":20}],"tint":null,"transfer":false,"flags":{"wire":{"applyOnSaveOrMiss":false,"applicationType":"immediate","blocksAreaConditions":false,"auraTargets":"","stackEffects":false,"rollEffects":false,"conditions":[],"independentDuration":false},"dae":{"specialDuration":[]}}}],"img":"icons/commodities/treasure/trinket-wing-white.webp","ownership":{"default":0,"Jd73bpddRreBTuIB":3,"TCd5yDOdSI6GIn6G":3},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.4","coreVersion":"10.291","createdTime":1666964193905,"modifiedTime":1676058118448,"lastModifiedBy":"Jd73bpddRreBTuIB"},"folder":null,"sort":0,"_id":"cgW5cs78CEe8R9XO"}
